<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f0f2f5; padding-bottom: 80px; }
        .page { display: none; }
        .active-page { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-active { color: #4f46e5 !important; font-weight: bold; }
        .post-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
    </style>
</head>
<body>

<header class="bg-indigo-700 text-white p-4 text-center shadow-md sticky top-0 z-50">
    <h1 class="text-xl font-bold">Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h1>
    <p class="text-[10px] opacity-90">Ù…ØµØ© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
</header>

<main class="p-4 max-w-md mx-auto">
    <section id="posts" class="page active-page">
        <div class="flex justify-between items-center mb-4 px-2">
            <h2 class="font-bold text-gray-700"><i class="fas fa-chalkboard-teacher ml-2"></i>Ø¢Ø®Ø± Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
            <button onclick="unlockAdmin()" class="text-[10px] bg-white text-indigo-700 px-3 py-1 rounded-full border border-indigo-200 font-bold shadow-sm">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div id="admin-panel" class="hidden bg-white p-5 rounded-3xl mb-8 border-2 border-indigo-600 shadow-2xl">
            <h3 class="font-bold text-indigo-700 mb-4 border-b pb-2">Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</h3>
            <textarea id="post-input" class="w-full bg-gray-50 rounded-xl p-3 text-sm mb-3 focus:ring-2 focus:ring-indigo-500 outline-none" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±Ø³ Ø£Ùˆ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§..."></textarea>
            <input id="post-img" type="text" class="w-full bg-gray-50 rounded-xl p-3 text-sm mb-4 outline-none" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button onclick="publishPost()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">Ù†Ø´Ø± Ù„Ù„Ø·Ù„Ø§Ø¨</button>
            
            <h3 class="font-bold text-indigo-700 mt-6 mb-4 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <div class="space-y-2">
                <input id="p-name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-2 border rounded-lg text-sm outline-none">
                <input id="p-exp" type="text" placeholder="Ø§Ù„ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" class="w-full p-2 border rounded-lg text-sm outline-none">
                <input id="p-wa" type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" class="w-full p-2 border rounded-lg text-sm outline-none">
                <input id="p-fb" type="text" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ" class="w-full p-2 border rounded-lg text-sm outline-none">
                <input id="p-img" type="text" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©" class="w-full p-2 border rounded-lg text-sm outline-none">
                <button onclick="saveProfile()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mt-2">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>

        <div id="posts-feed" class="space-y-6">
            <div class="text-center py-20 text-gray-400">
                <i class="fas fa-spinner animate-spin text-3xl mb-2"></i>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...</p>
            </div>
        </div>
    </section>

    <section id="ai" class="page">
        <div class="bg-white rounded-3xl shadow-lg border h-[70vh] flex flex-col">
            <div class="p-4 border-b bg-indigo-50 rounded-t-3xl text-center">
                <span class="font-bold text-indigo-700"><i class="fas fa-robot ml-2"></i>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠ</span>
            </div>
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div>
            <div class="p-3 border-t">
                <div class="flex gap-2">
                    <input id="ai-input" type="text" class="flex-1 border p-3 rounded-2xl text-sm outline-none focus:border-indigo-500" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ù…Ø³Ø£Ù„Ø©...">
                    <button onclick="callAI()" class="bg-indigo-600 text-white w-12 h-12 rounded-2xl shadow-md"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </section>

    <section id="contact" class="page">
        <div class="bg-white rounded-[40px] p-8 shadow-xl text-center border relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-24 bg-indigo-700"></div>
            <div id="profile-pic-disp" class="relative z-10 w-32 h-32 mx-auto mb-4 rounded-full border-4 border-white shadow-lg bg-gray-200 overflow-hidden">
                <i class="fas fa-user-tie text-5xl text-gray-400 mt-8"></i>
            </div>
            <h2 id="prof-name-disp" class="text-2xl font-bold text-gray-800">Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ</h2>
            <p id="prof-exp-disp" class="text-indigo-600 font-medium mb-8">Ø®Ø¨ÙŠØ± Ù…Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</p>
            <div class="grid grid-cols-1 gap-4">
                <a id="prof-wa-link" href="#" target="_blank" class="flex items-center justify-center gap-3 bg-green-500 text-white p-4 rounded-2xl font-bold shadow-md hover:opacity-90"><i class="fab fa-whatsapp text-xl"></i> ÙˆØ§ØªØ³Ø§Ø¨</a>
                <a id="prof-fb-link" href="#" target="_blank" class="flex items-center justify-center gap-3 bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-md hover:opacity-90"><i class="fab fa-facebook-f text-xl"></i> ÙÙŠØ³Ø¨ÙˆÙƒ</a>
            </div>
        </div>
    </section>
</main>

<nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around p-3 z-50 rounded-t-3xl shadow-2xl">
    <button onclick="showPage('posts')" id="btn-posts" class="flex flex-col items-center text-gray-400 nav-active"><i class="fas fa-home text-xl"></i><span class="text-[10px] mt-1">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
    <button onclick="showPage('ai')" id="btn-ai" class="flex flex-col items-center text-gray-400"><i class="fas fa-brain text-xl"></i><span class="text-[10px] mt-1">Ø§Ù„Ø°ÙƒØ§Ø¡</span></button>
    <button onclick="showPage('contact')" id="btn-contact" class="flex flex-col items-center text-gray-400"><i class="fas fa-user-circle text-xl"></i><span class="text-[10px] mt-1">Ø§Ù„Ø£Ø³ØªØ§Ø°</span></button>
</nav>

<script>
// 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
const firebaseConfig = { databaseURL: "https://genius-math-44207-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let isAdmin = false;
let currentProfile = {};

// 2. Ø§Ù„ØªÙ†Ù‚Ù„
function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.getElementById(id).classList.add('active-page');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
    document.getElementById('btn-' + id).classList.add('nav-active');
    window.scrollTo(0, 0);
}

// 3. Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
function unlockAdmin() {
    const pw = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯:");
    if(pw === "2025") {
        isAdmin = true;
        document.getElementById('admin-panel').classList.remove('hidden');
        alert("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø£Ø¯Ù…Ù†! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ù†Ø´Ø± ÙˆØ§Ù„Ø­Ø°Ù ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.");
        fillAdminForm();
    } else {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©.");
    }
}

// 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
function publishPost() {
    const text = document.getElementById('post-input').value.trim();
    const img = document.getElementById('post-img').value.trim();
    if(!text) return alert("Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹");
    
    db.ref('posts').push({
        text,
        img,
        date: new Date().toLocaleString('ar-EG'),
        likes: 0,
        dislikes: 0
    });
    document.getElementById('post-input').value = "";
    document.getElementById('post-img').value = "";
}

db.ref('posts').on('value', (snap) => {
    const feed = document.getElementById('posts-feed');
    feed.innerHTML = "";
    const data = snap.val();
    if(!data) { feed.innerHTML = "<div class='text-center py-10 text-gray-400'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>"; return; }

    Object.keys(data).reverse().forEach(postId => {
        const post = data[postId];
        let commentsSection = "";

        if(post.comments) {
            Object.keys(post.comments).forEach(comId => {
                const c = post.comments[comId];
                let repliesHtml = "";
                if(c.replies) {
                    Object.keys(c.replies).forEach(rId => {
                        const r = c.replies[rId];
                        repliesHtml += `
                        <div class="bg-indigo-50 p-2 rounded-xl text-[10px] mt-1 mr-4 border-r-2 border-indigo-300 relative">
                            <b class="${r.name === 'Admin' ? 'text-red-600' : 'text-indigo-600'}">${r.name}:</b> ${r.text}
                            ${isAdmin ? `<button onclick="deleteReply('${postId}','${comId}','${rId}')" class="absolute left-2 top-2 text-red-400 text-[8px]"><i class="fas fa-trash"></i></button>` : ""}
                        </div>`;
                    });
                }

                commentsSection += `
                <div class="bg-gray-50 p-3 rounded-2xl text-[11px] mb-2 border border-gray-100 relative">
                    <b class="${c.name === 'Admin' ? 'text-red-600' : 'text-indigo-800'}">${c.name}:</b> ${c.text}
                    <div class="mt-2 flex gap-3">
                        <button onclick="document.getElementById('r-box-${comId}').classList.toggle('hidden')" class="text-indigo-600 font-bold">Ø±Ø¯</button>
                        ${isAdmin ? `<button onclick="deleteComment('${postId}','${comId}')" class="text-red-500 font-bold">Ø­Ø°Ù</button>` : ""}
                    </div>
                    <div id="r-box-${comId}" class="hidden mt-2 space-y-2">
                        <input id="rn-${comId}" type="text" placeholder="Ø§Ø³Ù…Ùƒ" class="w-full p-2 border rounded-lg text-[10px] outline-none">
                        <div class="flex gap-1">
                            <input id="ri-${comId}" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." class="flex-1 p-2 border rounded-lg text-[10px] outline-none">
                            <button onclick="sendReply('${postId}','${comId}')" class="bg-indigo-500 text-white px-3 rounded-lg text-[10px]"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    <div class="reps-area mt-2">${repliesHtml}</div>
                </div>`;
            });
        }

        feed.innerHTML += `
        <div class="post-card">
            ${post.img ? `<img src="${post.img}" class="w-full h-48 object-cover">` : ""}
            <div class="p-5">
                <div class="flex justify-between items-start mb-3">
                    <p class="text-sm font-bold text-gray-800 leading-relaxed">${post.text}</p>
                    ${isAdmin ? `<button onclick="deletePost('${postId}')" class="text-red-500 bg-red-50 w-8 h-8 rounded-full"><i class="fas fa-trash-alt text-xs"></i></button>` : ""}
                </div>
                <div class="flex gap-4 text-xs text-gray-500 mb-4 bg-gray-50 p-2 rounded-xl">
                    <button onclick="vote('${postId}','likes')" class="flex items-center gap-1 hover:text-indigo-600"><i class="fas fa-thumbs-up"></i> ${post.likes||0}</button>
                    <button onclick="vote('${postId}','dislikes')" class="flex items-center gap-1 hover:text-red-600"><i class="fas fa-thumbs-down"></i> ${post.dislikes||0}</button>
                    <span class="mr-auto text-[9px] opacity-70">${post.date}</span>
                </div>
                <div class="border-t pt-4">
                    <div class="max-h-40 overflow-y-auto mb-3">${commentsSection}</div>
                    <div class="bg-indigo-50/50 p-3 rounded-2xl">
                        <input id="cn-${postId}" type="text" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full bg-white p-2 rounded-xl text-[10px] border-none mb-2 outline-none">
                        <div class="flex gap-2">
                            <input id="ci-${postId}" type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." class="flex-1 bg-white p-2 rounded-xl text-[11px] border-none outline-none">
                            <button onclick="sendComment('${postId}')" class="bg-indigo-600 text-white px-4 rounded-xl shadow-md"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    });
});

// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„
function checkName(n) {
    if(isAdmin) return "Admin";
    const blackList = ["admin", "Ø£Ø¯Ù…Ù†", "Ø§Ø¯Ù…Ù†", "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ", "Ø§Ù„Ø®ÙˆÙ„ÙŠ"];
    let name = n.trim();
    for(let word of blackList) if(name.toLowerCase().includes(word)) return "Stranger";
    return name || "Stranger";
}

function sendComment(pid) {
    const text = document.getElementById('ci-'+pid).value.trim();
    const name = checkName(document.getElementById('cn-'+pid).value);
    if(text) {
        db.ref(`posts/${pid}/comments`).push({ name, text });
        document.getElementById('ci-'+pid).value = "";
    }
}

function sendReply(pid, cid) {
    const text = document.getElementById('ri-'+cid).value.trim();
    const name = checkName(document.getElementById('rn-'+cid).value);
    if(text) {
        db.ref(`posts/${pid}/comments/${cid}/replies`).push({ name, text });
        document.getElementById('ri-'+cid).value = "";
        document.getElementById('r-box-'+cid).classList.add('hidden');
    }
}

function vote(id, type) {
    db.ref(`posts/${id}/${type}`).transaction(c => (c || 0) + 1);
}

// 6. Ø§Ù„Ø­Ø°Ù
function deletePost(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) db.ref(`posts/${id}`).remove(); }
function deleteComment(pid, cid) { if(confirm("Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ")) db.ref(`posts/${pid}/comments/${cid}`).remove(); }
function deleteReply(pid, cid, rid) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø¯ØŸ")) db.ref(`posts/${pid}/comments/${cid}/replies/${rid}`).remove(); }

// 7. Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
db.ref("profile").on("value", (snap) => {
    if(!snap.exists()) return;
    currentProfile = snap.val();
    document.getElementById("prof-name-disp").innerText = currentProfile.name || "Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ";
    document.getElementById("prof-exp-disp").innerText = currentProfile.exp || "Ø®Ø¨ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª";
    document.getElementById("prof-wa-link").href = currentProfile.wa || "#";
    document.getElementById("prof-fb-link").href = currentProfile.fb || "#";
    if(currentProfile.img) {
        document.getElementById("profile-pic-disp").innerHTML = `<img src="${currentProfile.img}" class="w-full h-full object-cover">`;
    }
});

function saveProfile() {
    if(!isAdmin) return;
    const data = {
        name: document.getElementById("p-name").value,
        exp: document.getElementById("p-exp").value,
        wa: document.getElementById("p-wa").value,
        fb: document.getElementById("p-fb").value,
        img: document.getElementById("p-img").value
    };
    db.ref("profile").set(data).then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!"));
}

function fillAdminForm() {
    document.getElementById("p-name").value = currentProfile.name || "";
    document.getElementById("p-exp").value = currentProfile.exp || "";
    document.getElementById("p-wa").value = currentProfile.wa || "";
    document.getElementById("p-fb").value = currentProfile.fb || "";
    document.getElementById("p-img").value = currentProfile.img || "";
}

// 8. Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
async function callAI() {
    const input = document.getElementById("ai-input");
    const msg = input.value.trim();
    if(!msg) return;
    
    const chat = document.getElementById("chat-box");
    chat.innerHTML += `<div class="bg-white p-3 rounded-2xl rounded-tr-none text-sm shadow-sm self-end text-right border max-w-[80%] mr-auto"><b>Ø£Ù†Øª:</b> ${msg}</div>`;
    input.value = "";
    
    const loading = document.createElement("div");
    loading.className = "bg-indigo-100 p-3 rounded-2xl rounded-tl-none text-sm text-indigo-800 max-w-[80%] ml-auto";
    loading.innerText = "ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙÙŠ Ø§Ù„Ø­Ù„...";
    chat.appendChild(loading);
    chat.scrollTop = chat.scrollHeight;

    try {
        const res = await fetch("/.netlify/functions/gemini", {
            method: "POST",
            body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        loading.innerHTML = `<b>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯:</b> ${data.reply || "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø¥ÙŠØ¬Ø§Ø¯ Ø­Ù„."}`;
    } catch {
        loading.innerText = "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø°ÙƒÙŠ.";
    }
    chat.scrollTop = chat.scrollHeight;
}
</script>
</body>
</html>
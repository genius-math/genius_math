<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/hPGFj3dk/20230624_170110.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7fe; padding-bottom: 90px; overflow-x: hidden; }
        .page { display: none; }
        .active-page { display: block; }
        .nav-active { color: #4f46e5 !important; font-weight: bold; }
        #auth-overlay { position: fixed; inset: 0; background: #4338ca; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #sidebar { position: fixed; top: 0; right: -100%; width: 80%; max-width: 300px; height: 100%; background: white; z-index: 1001; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        #sidebar.open { right: 0; }
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .option-btn { border: 2px solid #e5e7eb; transition: 0.2s; text-align: right; width: 100%; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 13px; background: #f9fafb; }
        .option-btn.selected { border-color: #4f46e5; background-color: #eef2ff; }
        .correct { background-color: #10b981 !important; color: white; border-color: #059669; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #dc2626; }
        /* Notifications Styles */
        #notif-dropdown { position: absolute; top: 60px; left: 10px; width: 280px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; display: none; max-height: 400px; overflow-y: auto; }
                /* Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ­Ø¯Ø«Ù‡ Ù„ÙŠØµØ¨Ø­ Ù‡ÙƒØ°Ø§ */
                .notif-item { 
                padding: 12px; 
                border-bottom: 1px solid #f1f5f9; 
                font-size: 11px; 
                cursor: pointer; 
                color: #1e293b; /* ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù†Øµ */
                line-height: 1.5; /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ± Ù„Ù„ÙˆØ¶ÙˆØ­ */
                }
                
                .notif-unread { 
                background: #f5f7ff; 
                border-right: 4px solid #4f46e5; 
                font-weight: bold; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ø¨Ø®Ø· Ø³Ù…ÙŠÙƒ */
                color: #000000; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙˆØ¯ Ø§Ù„ØµØ±ÙŠØ­ */
                }.notif-unread { background: #f5f7ff; border-right: 4px solid #4f46e5; }
        .unread-dot { width: 10px; height: 10px; background: #ef4444; border-radius: 50%; position: absolute; top: -2px; right: -2px; border: 2px solid white; }
    /* Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ØªÙˆØ¶Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ <style> */
    .notif-unread { 
    background: #eef2ff !important; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ù…ÙŠØ² Ù„Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„ÙØ§ØªØ­ */
    border-right: 5px solid #4f46e5 !important; /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ø±ÙŠØ¶ Ø£Ø²Ø±Ù‚ */
    font-weight: bold !important;
    color: #000000 !important;
    }
    
    .notif-read { 
    background: #ffffff !important; 
    border-right: 5px solid #e5e7eb !important; /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
    opacity: 0.9; 
    color: #4b5563 !important;
    }
    /* Ø¥Ø¶Ø§ÙØ© Ø´ÙƒÙ„ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ */
    #install-container {
    background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
    transition: transform 0.3s ease;
    }
    #install-container:active { transform: scale(0.95); }
    .animate-bounce-slow { animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="bg-white w-full max-w-sm rounded-[30px] p-8 shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-indigo-700 mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
        <p class="text-gray-500 text-xs mb-6">Ù…Ù†ØµØ© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
        <div class="space-y-4">
            <input id="user-fullname" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¹Ø±Ø¨ÙŠ)" class="w-full border rounded-2xl p-3 text-sm outline-none text-center">
            <input id="user-id" type="text" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… (English)" class="w-full border rounded-2xl p-3 text-sm outline-none text-center" oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()">
            <input id="user-whatsapp" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" class="w-full border rounded-2xl p-3 text-sm outline-none text-center">
            <button onclick="handleAuth()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
        </div>
        <p id="auth-msg" class="text-red-500 text-[10px] mt-4 font-bold"></p>
    </div>
</div>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar" class="p-6">
    <div class="flex justify-between items-center mb-8">
        <h2 class="font-bold text-xl text-indigo-700">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h2>
        <button onclick="toggleSidebar()" class="text-2xl">&times;</button>
    </div>

    

    <div class="space-y-4">
        <button onclick="showPage('ask-me')" class="w-full text-right p-4 rounded-xl bg-blue-50 text-blue-700 font-bold flex items-center gap-3"><i class="fas fa-question-circle"></i> Ø§Ø³Ø£Ù„Ù†ÙŠ</button>
        <button onclick="showEducationPage('quizzes')" class="w-full text-right p-4 rounded-xl bg-indigo-50 text-indigo-700 font-bold flex items-center gap-3"><i class="fas fa-tasks"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        <button onclick="showEducationPage('videos')" class="w-full text-right p-4 rounded-xl bg-red-50 text-red-700 font-bold flex items-center gap-3"><i class="fab fa-youtube"></i> Ø§Ù„Ø´Ø±ÙˆØ­Ø§Øª</button>
        <button onclick="showEducationPage('books')" class="w-full text-right p-4 rounded-xl bg-green-50 text-green-700 font-bold flex items-center gap-3"><i class="fas fa-file-pdf"></i> Ø§Ù„Ù…Ù„Ø§Ø²Ù…</button>
        <button onclick="showPage('achievements')" class="w-full text-right p-4 rounded-xl bg-orange-50 text-orange-700 font-bold flex items-center gap-3"><i class="fas fa-star"></i> Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ</button>
    </div>
    <div id="install-container" class="p-4 mb-6 mx-4 rounded-2xl shadow-lg text-white bg-gradient-to-r from-indigo-600 to-blue-500">
    <button id="install-btn" class="w-full text-right flex items-center gap-3 font-bold text-sm">
    <i class="fas fa-download animate-bounce"></i>
    <span> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ </span>
    </button>
    <div class="mt-2 pt-2 border-t border-white/20 text-[10px] flex justify-between items-center font-semibold">
    <span>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
    <span class="bg-white/20 px-2 py-0.5 rounded-full">
    <i class="fas fa-users ml-1"></i>
    <span id="install-count-public">0</span> ØªÙ†Ø²ÙŠÙ„
    </span>
    </div>
    </div>
</div>

<header class="bg-indigo-700 text-white p-5 shadow-xl sticky top-0 z-50 rounded-b-[30px] flex justify-between items-center">
    <button onclick="toggleSidebar()" class="text-xl px-2"><i class="fas fa-bars"></i></button>
    <h1 onclick="handleSecretClick()" class="text-xl font-bold cursor-pointer select-none">Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</h1>
    <div class="relative">
        <button onclick="toggleNotifs()" class="text-xl pt-1"><i class="fas fa-bell"></i></button>
        <div id="notif-badge" class="unread-dot hidden"></div>
        <div id="notif-dropdown">
            <div class="p-3 border-b font-bold text-xs text-indigo-700">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
            <div id="notif-list"></div>
        </div>
    </div>
</header>

<main class="p-4 max-w-md mx-auto">
    <section id="admin-panel" class="hidden bg-white p-6 rounded-[30px] mb-8 border-2 border-indigo-600 shadow-2xl overflow-y-auto max-h-[85vh]">
    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mb-6 flex justify-between items-center">
    <span class="text-xs font-bold text-indigo-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:</span>
    <span id="admin-install-count" class="text-xl font-black text-indigo-600">0</span>
    </div>
        <h3 class="font-bold text-indigo-700 mb-4 border-b pb-2 text-center">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <select id="admin-select-sec" class="w-full p-2 mb-4 border rounded-xl text-xs" onchange="switchAdminView()">
            <option value="posts">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø£ÙˆØ§Ø¦Ù„</option>
            <option value="quiz">Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±</option>
            <option value="inbox">Ø·Ù„Ø¨Ø§Øª Ø§Ø³Ø£Ù„Ù†ÙŠ</option>
            <option value="results">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
            <option value="content">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙˆÙ…Ù„Ø§Ø²Ù…</option>
        </select>

        <div id="adm-posts" class="adm-section space-y-3">
            <textarea id="post-input" class="w-full border rounded-xl p-2 text-xs" placeholder="Ø§ÙƒØªØ¨ Ø¨ÙˆØ³Øª Ø¬Ø¯ÙŠØ¯..."></textarea>
            <input id="post-img" type="text" class="w-full border rounded-xl p-2 text-xs" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
            <button onclick="publishPost()" class="w-full bg-indigo-600 text-white py-2 rounded-xl text-xs font-bold">Ù†Ø´Ø± ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
            <hr>
            <input id="top-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ØªÙÙˆÙ‚" class="w-full border rounded-xl p-2 text-xs">
            <input id="top-img" type="text" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full border rounded-xl p-2 text-xs">
            <button onclick="addTopStudent()" class="w-full bg-yellow-500 text-white py-2 rounded-xl text-xs font-bold">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø£ÙˆØ§Ø¦Ù„</button>
        </div>

        <div id="adm-inbox" class="adm-section hidden space-y-3">
            <div id="admin-questions-list" class="space-y-3"></div>
        </div>

        <div id="adm-results" class="adm-section hidden space-y-3">
            <div id="admin-results-list" class="space-y-2"></div>
        </div>

        <div id="adm-quiz" class="adm-section hidden space-y-3">
            <input id="q-title" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" class="w-full border rounded-xl p-2 text-xs">
            <div class="flex gap-1">
                <select id="q-grade" class="flex-1 p-2 border rounded-xl text-[10px] stage-select"></select>
                <select id="q-term" class="flex-1 p-2 border rounded-xl text-[10px]"><option>ØªØ±Ù… Ø£ÙˆÙ„</option><option>ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option></select>
            </div>
            <div id="questions-builder" class="space-y-4"></div>
            <button onclick="addQuestionUI()" class="w-full bg-gray-100 py-2 rounded-xl text-[10px]">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
            <button onclick="saveQuiz()" class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold">Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø®Ø·Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>

        <div id="adm-content" class="adm-section hidden space-y-3">
            <select id="cont-type" class="w-full p-2 border rounded-xl text-xs"><option value="video">ÙÙŠØ¯ÙŠÙˆ</option><option value="book">Ù…Ù„Ø²Ù…Ø©</option></select>
            <input id="cont-title" type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="w-full border rounded-xl p-2 text-xs">
            <input id="cont-link" type="text" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" class="w-full border rounded-xl p-2 text-xs">
            <button onclick="addContent()" class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <button onclick="localStorage.clear(); location.reload();" class="w-full text-gray-400 text-[10px] mt-6">Ø®Ø±ÙˆØ¬</button>
    </section>

    <section id="posts" class="page active-page"><div id="posts-feed" class="space-y-6"></div></section>
    
    <section id="ask-me" class="page">
        <div class="bg-white rounded-[30px] p-6 shadow-sm border mb-6">
            <h2 class="font-bold text-indigo-700 mb-4 text-center">Ø§Ø³Ø£Ù„ Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ğŸ§ </h2>
            <textarea id="ask-text" class="w-full border p-3 rounded-2xl text-xs outline-none mb-3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
            <input id="ask-img-inp" type="text" class="w-full border p-3 rounded-2xl text-xs outline-none mb-3" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button onclick="submitQuestion()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø£Ø³ØªØ§Ø°</button>
        </div>
        <div id="my-questions" class="space-y-4"></div>
    </section>

    <section id="achievements" class="page">
        <div class="bg-white rounded-[30px] p-8 shadow-xl text-center mb-6 border">
            <i class="fas fa-trophy text-4xl text-yellow-500 mb-4"></i>
            <h2 class="text-xl font-bold mb-4" id="dash-name">Ù„ÙˆØ­Ø© Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-indigo-50 p-4 rounded-2xl"><p class="text-[10px] text-gray-500">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù†Ø¬Ø²Ø©</p><p id="dash-tests-count" class="text-2xl font-bold text-indigo-700">0</p></div>
                <div class="bg-green-50 p-4 rounded-2xl"><p class="text-[10px] text-gray-500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p><p id="dash-avg" class="text-2xl font-bold text-green-600">0%</p></div>
            </div>
        </div>
        <div id="tests-history" class="space-y-3"></div>
    </section>

    <section id="top-students" class="page"><div id="students-list" class="grid grid-cols-2 gap-4"></div></section>
    <section id="edu-page" class="page">
        <div class="flex gap-2 mb-4">
            <select id="filter-grade" class="flex-1 p-2 bg-white rounded-xl shadow-sm text-xs stage-select" onchange="renderEducation()"></select>
            <select id="filter-term" class="flex-1 p-2 bg-white rounded-xl shadow-sm text-xs" onchange="renderEducation()"><option>ØªØ±Ù… Ø£ÙˆÙ„</option><option>ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option></select>
        </div>
        <div id="edu-list" class="space-y-4"></div>
    </section>

    <section id="quiz-view" class="page">
        <div class="bg-white rounded-[30px] p-6 shadow-xl border">
            <h2 id="active-q-title" class="text-center font-bold text-indigo-700 mb-6"></h2>
            <div id="quiz-questions-container" class="space-y-10"></div>
            <button id="submit-quiz-btn" onclick="finishQuiz()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold mt-10 shadow-lg">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
            <div id="quiz-result" class="hidden mt-8 text-center border-t pt-6">
                <p class="text-gray-500 mb-2">Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p>
                <div id="score-circle" class="w-20 h-20 rounded-full bg-indigo-600 text-white flex items-center justify-center mx-auto text-2xl font-bold mb-6"></div>
                <button onclick="shareResult()" class="bg-green-500 text-white px-8 py-3 rounded-2xl font-bold"><i class="fab fa-whatsapp ml-2"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
            </div>
        </div>
    </section>

    <section id="contact" class="page">
        <div class="bg-white rounded-[40px] p-8 shadow-xl border text-center">
            <div id="profile-pic-disp" class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-white shadow overflow-hidden flex items-center justify-center"></div>
            <h2 id="prof-name-disp" class="text-xl font-bold text-indigo-700">Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®ÙˆÙ„ÙŠ</h2>
            <div class="space-y-3 mt-6">
                <a id="prof-wa-link" href="#" target="_blank" class="block bg-green-500 text-white p-3 rounded-2xl font-bold">ÙˆØ§ØªØ³Ø§Ø¨</a>
                <a id="prof-fb-link" href="#" target="_blank" class="block bg-blue-600 text-white p-3 rounded-2xl font-bold">ÙÙŠØ³Ø¨ÙˆÙƒ</a>
            </div>
        </div>
    </section>
</main>

<nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 z-50 rounded-t-[30px] shadow-2xl">
    <button onclick="showPage('posts')" id="btn-posts" class="flex flex-col items-center text-gray-400 nav-active"><i class="fas fa-home"></i><span class="text-[10px] mt-1">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
    <button onclick="showPage('top-students')" id="btn-top-students" class="flex flex-col items-center text-gray-400"><i class="fas fa-medal"></i><span class="text-[10px] mt-1">Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</span></button>
    <button onclick="showPage('contact')" id="btn-contact" class="flex flex-col items-center text-gray-400"><i class="fas fa-user-tie"></i><span class="text-[10px] mt-1">Ø§Ù„Ø£Ø³ØªØ§Ø°</span></button>
</nav>

<script>
const firebaseConfig = { databaseURL: "https://genius-math-44207-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const stages = ["Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"];
document.querySelectorAll('.stage-select').forEach(sel => {
    stages.forEach(s => sel.innerHTML += `<option>${s}</option>`);
});

let isAdmin = false, sCount = 0, eduType = 'quizzes', activeQuizData = null, userAnswers = {};
let currentUser = JSON.parse(localStorage.getItem('math_user')) || null;

if(currentUser) {
    document.getElementById('auth-overlay').style.display = 'none';
    listenToNotifs();
    renderAchievements();
}

function handleAuth() {
    const name = document.getElementById('user-fullname').value, uid = document.getElementById('user-id').value, wa = document.getElementById('user-whatsapp').value;
    if(!name || !uid || !wa) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    const userData = { fullname: name, username: uid, whatsapp: wa };
    db.ref('users/' + uid).set(userData).then(() => {
        localStorage.setItem('math_user', JSON.stringify(userData));
        location.reload();
    });
}

function showPage(id) { 
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.getElementById(id).classList.add('active-page');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
    if(document.getElementById('btn-'+id)) document.getElementById('btn-'+id).classList.add('nav-active');
    if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    const over = document.getElementById('sidebar-overlay');
    over.style.display = over.style.display === 'block' ? 'none' : 'block';
}

function showEducationPage(type) { eduType = type; toggleSidebar(); showPage('edu-page'); renderEducation(); }

function handleSecretClick() { sCount++; if(sCount === 5) { if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "2025") { 
    isAdmin = true; 
    document.getElementById('admin-panel').classList.remove('hidden'); 
    renderAdminInbox();
    renderAdminResults();
} sCount = 0; } }

function switchAdminView() {
    const val = document.getElementById('admin-select-sec').value;
    document.querySelectorAll('.adm-section').forEach(s => s.classList.add('hidden'));
    document.getElementById('adm-' + val).classList.remove('hidden');
}

// Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
// 1. Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© listenToNotifs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯
function listenToNotifs() {
    db.ref('notifications/' + currentUser.username).on('value', snap => {
        const list = document.getElementById('notif-list'); 
        list.innerHTML = "";
        const data = snap.val(); 
        if(!data) {
            document.getElementById('notif-badge').classList.add('hidden');
            return;
        }
        
        let unreadCount = 0;
        Object.keys(data).reverse().forEach(id => {
            const isRead = data[id].read;
            if(!isRead) unreadCount++; // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ÙØ¹Ù„ÙŠØ§Ù‹
            
            let targetPage = 'posts';
            if(data[id].msg.includes('Ø§Ø®ØªØ¨Ø§Ø±')) targetPage = 'edu-page';
            if(data[id].msg.includes('Ø³Ø¤Ø§Ù„Ùƒ')) targetPage = 'ask-me';

            list.innerHTML += `
                <div class="notif-item ${isRead ? 'notif-read' : 'notif-unread'}" 
                     onclick="handleNotifClick('${targetPage}', '${id}')">
                    ${data[id].msg}<br>
                    <span class="text-[9px] text-gray-700 font-bold mt-1 inline-block">${data[id].time}</span>
                </div>`;
        });

        // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù„Ø§ ØªØ¸Ù‡Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© (unreadCount > 0)
        if (unreadCount > 0) {
            document.getElementById('notif-badge').classList.remove('hidden');
        } else {
            document.getElementById('notif-badge').classList.add('hidden');
        }
    });
}

// 2. Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© toggleNotifs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ (Ù„ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø· Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)
function toggleNotifs() {
    const d = document.getElementById('notif-dropdown');
    d.style.display = d.style.display === 'block' ? 'none' : 'block';
}

// 3. Ø£Ø¶Ù Ø¯Ø§Ù„Ø© handleNotifClick Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªÙ…Ø§Ù…Ø§Ù‹
function handleNotifClick(pageId, notifId) {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø¹Ù„ÙŠÙ‡ ÙÙ‚Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.ref('notifications/' + currentUser.username + '/' + notifId).update({
        read: true
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
    document.getElementById('notif-dropdown').style.display = 'none';
    
    // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (pageId === 'edu-page') {
        showEducationPage('quizzes');
    } else {
        showPage(pageId);
    }
}

function markAllNotifsRead() {
    db.ref('notifications/' + currentUser.username).once('value', s => {
        s.forEach(child => child.ref.update({read: true}));
    });
}

function sendGlobalNotif(msg) {
    db.ref('users').once('value', snap => {
        snap.forEach(user => {
            db.ref('notifications/' + user.key).push({ msg: msg, time: getFullDateTime(), read: false });
        });
    });
}

// Ø±ÙƒÙ† Ø§Ø³Ø£Ù„Ù†ÙŠ
function submitQuestion() {
    const t = document.getElementById('ask-text').value, i = document.getElementById('ask-img-inp').value;
    if(!t && !i) return alert("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©");
    db.ref('tickets').push({ uid: currentUser.username, name: currentUser.fullname, text: t, img: i, status: 'Ù…ÙØªÙˆØ­', time: getFullDateTime() });
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById('ask-text').value = ""; document.getElementById('ask-img-inp').value = "";
}

db.ref('tickets').on('value', snap => {
    if(!currentUser) return;
    const div = document.getElementById('my-questions'); div.innerHTML = "";
    const data = snap.val(); if(!data) return;
    Object.keys(data).reverse().forEach(id => {
        if(data[id].uid === currentUser.username) {
            div.innerHTML += `<div class="bg-white p-4 rounded-2xl border mb-3 shadow-sm">
                <div class="flex justify-between text-[10px] text-gray-400 mb-2"><span>${data[id].time}</span><span class="${data[id].status==='Ù…ÙØªÙˆØ­'?'text-green-500':'text-red-500'}">${data[id].status}</span></div>
                <p class="text-xs font-bold">${data[id].text}</p>
                ${data[id].img ? `<img src="${data[id].img}" class="w-24 mt-2 rounded border">` : ""}
                ${data[id].answer ? `<div class="mt-3 p-2 bg-indigo-50 rounded-lg text-xs border-r-2 border-indigo-600"><b>Ø±Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°:</b> ${data[id].answer}</div>` : ""}
            </div>`;
        }
    });
});

function renderAdminInbox() {
    db.ref('tickets').on('value', snap => {
        const list = document.getElementById('admin-questions-list'); list.innerHTML = "";
        const data = snap.val(); if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            list.innerHTML += `<div class="bg-gray-50 p-3 rounded-xl border text-[11px]">
                <b>Ù…Ù†: ${data[id].name}</b><p>${data[id].text}</p>
                ${data[id].img ? `<img src="${data[id].img}" class="w-16 my-1">` : ""}
                <textarea id="ans-${id}" class="w-full border mt-2 p-1 rounded" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯...">${data[id].answer||''}</textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="replyTicket('${id}','${data[id].uid}')" class="bg-indigo-600 text-white px-3 py-1 rounded">Ø±Ø¯ ÙˆØ§Ø´Ø¹Ø§Ø±</button>
                    <button onclick="deleteItem('tickets/${id}')" class="text-red-500">Ø­Ø°Ù</button>
                </div>
            </div>`;
        });
    });
}

function replyTicket(id, uid) {
    const ans = document.getElementById('ans-'+id).value;
    db.ref('tickets/'+id).update({ answer: ans, status: 'ØªÙ… Ø§Ù„Ø±Ø¯' }).then(() => {
        db.ref('notifications/' + uid).push({ msg: "âœ… Ù‚Ø§Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø±ÙƒÙ† Ø§Ø³Ø£Ù„Ù†ÙŠ", time: getFullDateTime(), read: false });
        alert("ØªÙ… Ø§Ù„Ø±Ø¯");
    });
}

// Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬
function renderAchievements() {
    db.ref('results').orderByChild('uid').equalTo(currentUser.username).on('value', snap => {
        const data = snap.val();
        const history = document.getElementById('tests-history'); history.innerHTML = "";
        if(!data) return;
        let count = 0, totalScore = 0;
        Object.keys(data).forEach(id => {
            count++;
            totalScore += data[id].percent;
            history.innerHTML += `<div class="bg-white p-3 rounded-xl border flex justify-between items-center text-xs">
                <span>${data[childId='title'] || 'Ø§Ø®ØªØ¨Ø§Ø±'}</span><span class="font-bold text-indigo-600">${data[id].percent}%</span>
            </div>`;
        });
        document.getElementById('dash-tests-count').innerText = count;
        document.getElementById('dash-avg').innerText = count > 0 ? Math.round(totalScore/count) + "%" : "0%";
    });
}

function renderAdminResults() {
    db.ref('results').on('value', snap => {
        const list = document.getElementById('admin-results-list'); list.innerHTML = "";
        const data = snap.val(); if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            list.innerHTML += `<div class="p-2 border-b text-[10px] flex justify-between items-center">
                <span><b>${data[id].userName}</b> - ${data[id].quizTitle}</span>
                <span class="font-bold">${data[id].score}/${data[id].total} (${data[id].percent}%)</span>
            </div>`;
        });
    });
}

// Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ø§Ù„Ù…Ø¹Ø¯Ù„)
let qCount = 0;
function addQuestionUI() {
    qCount++;
    const div = document.createElement('div');
    div.className = "p-4 bg-gray-50 rounded-2xl border border-gray-200 relative";
    div.innerHTML = `
        <button onclick="this.parentElement.remove()" class="absolute top-2 left-2 text-red-500 text-xs">Ø­Ø°Ù</button>
        <p class="text-[10px] font-bold text-indigo-600 mb-2">Ø³Ø¤Ø§Ù„ ${qCount}</p>
        <textarea placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full p-2 mb-2 text-xs border rounded-lg q-text"></textarea>
        <input type="text" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full p-2 mb-2 text-xs border rounded-lg q-img">
        <div class="grid grid-cols-2 gap-2 mb-2">
            <input type="text" placeholder="Ø£" class="p-2 border rounded-lg text-[10px] opt-0">
            <input type="text" placeholder="Ø¨" class="p-2 border rounded-lg text-[10px] opt-1">
            <input type="text" placeholder="Ø¬" class="p-2 border rounded-lg text-[10px] opt-2">
            <input type="text" placeholder="Ø¯" class="p-2 border rounded-lg text-[10px] opt-3">
        </div>
        <select class="w-full p-2 text-[10px] border rounded-lg bg-green-50 q-correct">
            <option value="0">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø£) Ù‡ÙŠ Ø§Ù„ØµØ­ÙŠØ­Ø©</option><option value="1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¨) Ù‡ÙŠ Ø§Ù„ØµØ­ÙŠØ­Ø©</option>
            <option value="2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¬) Ù‡ÙŠ Ø§Ù„ØµØ­ÙŠØ­Ø©</option><option value="3">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¯) Ù‡ÙŠ Ø§Ù„ØµØ­ÙŠØ­Ø©</option>
        </select>
    `;
    document.getElementById('questions-builder').appendChild(div);
}

function saveQuiz() {
    const title = document.getElementById('q-title').value;
    const questions = [];
    document.querySelectorAll('#questions-builder > div').forEach(d => {
        questions.push({
            text: d.querySelector('.q-text').value, img: d.querySelector('.q-img').value,
            options: [d.querySelector('.opt-0').value, d.querySelector('.opt-1').value, d.querySelector('.opt-2').value, d.querySelector('.opt-3').value],
            correct: parseInt(d.querySelector('.q-correct').value)
        });
    });
    db.ref('quizzes').push({ title, grade: document.getElementById('q-grade').value, term: document.getElementById('q-term').value, questions, date: getFullDateTime() }).then(() => {
        sendGlobalNotif(`ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯: ${title}`);
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø®Ø·Ø§Ø±"); location.reload();
    });
}

function finishQuiz() {
    let score = 0;
    activeQuizData.questions.forEach((q, i) => {
        const block = document.getElementById(`q-block-${i}`);
        block.querySelectorAll('.option-btn').forEach((b, bi) => {
            b.disabled = true;
            if(bi === q.correct) b.classList.add('correct');
            else if(userAnswers[i] === bi) b.classList.add('wrong');
        });
        if(userAnswers[i] === q.correct) score++;
    });
    
    const percent = Math.round((score / activeQuizData.questions.length) * 100);
    db.ref('results').push({ 
        uid: currentUser.username, userName: currentUser.fullname, 
        quizTitle: activeQuizData.title, score: score, total: activeQuizData.questions.length, 
        percent: percent, time: getFullDateTime() 
    });

    document.getElementById('submit-quiz-btn').classList.add('hidden');
    document.getElementById('quiz-result').classList.remove('hidden');
    document.getElementById('score-circle').innerText = `${score}/${activeQuizData.questions.length}`;
    activeQuizData.finalScore = score;
}

// Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¯Ø© Ù…Ù† index.03
function renderEducation() {
    const list = document.getElementById('edu-list'); list.innerHTML = "";
    const g = document.getElementById('filter-grade').value, t = document.getElementById('filter-term').value;
    db.ref(eduType).on('value', snap => {
        list.innerHTML = "";
        const data = snap.val(); if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            const item = data[id];
            if(item.grade === g && item.term === t) {
                list.innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 border-indigo-600 flex justify-between items-center">
                    <div><h4 class="font-bold text-sm">${item.title}</h4></div>
                    <div class="flex gap-2">
                        ${isAdmin ? `<button onclick="deleteItem('${eduType}/${id}')" class="text-red-500 text-xs">Ø­Ø°Ù</button>` : ""}
                        <button onclick="openContent('${eduType}','${id}')" class="bg-indigo-600 text-white px-4 py-1 rounded-lg text-xs">ÙØªØ­</button>
                    </div>
                </div>`;
            }
        });
    });
}

function openContent(type, id) {
    db.ref(`${type}/${id}`).once('value', snap => {
        const item = snap.val();
        if(type==='quizzes') { activeQuizData = item; userAnswers = {}; startQuiz(item); }
        else window.open(item.link, '_blank');
    });
}

function startQuiz(quiz) {
    showPage('quiz-view');
    document.getElementById('active-q-title').innerText = quiz.title;
    const container = document.getElementById('quiz-questions-container'); container.innerHTML = "";
    quiz.questions.forEach((q, i) => {
        container.innerHTML += `<div id="q-block-${i}">
            <p class="font-bold text-sm mb-2">${i+1}. ${q.text}</p>
            ${q.img ? `<img src="${q.img}" class="w-full rounded-xl mb-3 shadow-sm border">` : ""}
            <div class="space-y-2">${q.options.map((o, oi) => `<button onclick="selectOption(${i},${oi},this)" class="option-btn">${o}</button>`).join('')}</div>
        </div>`;
    });
}

function selectOption(qi, oi, btn) {
    userAnswers[qi] = oi;
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

function shareResult() {
    const text = `Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${activeQuizData.finalScore} Ù…Ù† ${activeQuizData.questions.length} ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± (${activeQuizData.title}) Ù…Ø¹ Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª! ğŸ§ ğŸ”¥`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
}

function getFullDateTime() { return new Date().toLocaleDateString('ar-EG', { day: 'numeric', month: 'numeric', hour: '2-digit', minute: '2-digit' }); }
function deleteItem(path) { if(confirm("Ø­Ø°ÙØŸ")) db.ref(path).remove(); }
function publishPost() { 
    const t = document.getElementById('post-input').value, i = document.getElementById('post-img').value; 
    if(t) db.ref('posts').push({ text: t, img: i, date: getFullDateTime(), likes: 0 }).then(() => sendGlobalNotif(`ğŸ“¢ Ø¨ÙˆØ³Øª Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³ØªØ§Ø°: ${t.substring(0,30)}...`)); 
}
function addTopStudent() { const n = document.getElementById('top-name').value, i = document.getElementById('top-img').value; if(n) db.ref('top_students').push({ name: n, img: i }); }

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
db.ref('posts').on('value', snap => {
    const feed = document.getElementById('posts-feed'); feed.innerHTML = "";
    const data = snap.val(); if(!data) return;
    Object.keys(data).reverse().forEach(pid => {
        const p = data[pid]; let total = 0; let coms = "";
        if(p.comments) {
            Object.keys(p.comments).forEach(cid => {
                const c = p.comments[cid]; total++;
                let reps = "";
                if(c.replies) Object.keys(c.replies).forEach(rid => { total++; reps += `<div class="bg-white p-2 rounded-lg text-[9px] mt-1 mr-4 border"><b>${c.replies[rid].name}:</b> ${c.replies[rid].text}</div>`; });
                coms += `<div class="bg-gray-50 p-2 rounded-xl text-[10px] mb-2 border-r-2 border-indigo-200">
                    <div class="flex justify-between"><b>${c.name}:</b> <span class="text-[8px] text-gray-400">${c.time||''}</span></div>
                    ${c.text}
                    <button onclick="document.getElementById('rb-${cid}').classList.toggle('hidden')" class="text-indigo-500 block text-[9px] mt-1">Ø±Ø¯</button>
                    <div id="rb-${cid}" class="hidden flex mt-1"><input id="ri-${cid}" class="flex-1 border rounded p-1 text-[8px]"><button onclick="sendReply('${pid}','${cid}')" class="bg-indigo-500 text-white px-2 rounded">âœ”</button></div>
                    ${reps}
                </div>`;
            });
        }
        feed.innerHTML += `<div class="bg-white rounded-[25px] shadow-sm border overflow-hidden">
            ${p.img ? `<img src="${p.img}" class="w-full max-h-80 object-contain bg-gray-50">` : ""}
            <div class="p-4"><p class="text-sm font-bold">${p.text}</p><div class="flex justify-between items-center mt-3 pt-2 border-t">
                <button onclick="toggleLike('${pid}')" class="text-red-500 text-xs font-bold"><i class="fas fa-heart"></i> ${p.likes||0}</button>
                <button onclick="document.getElementById('csec-${pid}').classList.toggle('hidden')" class="text-indigo-600 text-xs font-bold">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${total})</button>
            </div><div id="csec-${pid}" class="hidden mt-4">${coms}<div class="flex gap-1 mt-2"><input id="ci-${pid}" placeholder="ØªØ¹Ù„ÙŠÙ‚..." class="flex-1 bg-gray-50 p-2 rounded-xl text-[10px]"><button onclick="sendCom('${pid}')" class="bg-indigo-600 text-white px-3 rounded-xl">âœ”</button></div></div></div></div>`;
    });
});

function toggleLike(pid) { const r = db.ref(`posts/${pid}/likedBy/${currentUser.username}`); r.once('value', s => { if(s.exists()) { r.remove(); db.ref(`posts/${pid}/likes`).transaction(c => c-1); } else { r.set(true); db.ref(`posts/${pid}/likes`).transaction(c => (c||0)+1); } }); }
function sendCom(pid) { const t = document.getElementById('ci-'+pid).value; if(t) { db.ref(`posts/${pid}/comments`).push({ name: isAdmin?"Ø§Ù„Ø£Ø¯Ù…Ù†":currentUser.fullname, text: t, time: getFullDateTime(), uid: currentUser.username }); document.getElementById('ci-'+pid).value=""; } }
function sendReply(pid, cid) { const t = document.getElementById('ri-'+cid).value; if(t) { db.ref(`posts/${pid}/comments/${cid}/replies`).push({ name: isAdmin?"Ø§Ù„Ø£Ø¯Ù…Ù†":currentUser.fullname, text: t, time: getFullDateTime(), uid: currentUser.username }); document.getElementById('ri-'+cid).value=""; } }
function addContent() { const t = document.getElementById('cont-type').value==='video'?'videos':'books'; db.ref(t).push({ title: document.getElementById('cont-title').value, link: document.getElementById('cont-link').value, grade: document.getElementById('q-grade').value, term: document.getElementById('q-term').value }).then(() => alert("ØªÙ…")); }

db.ref('top_students').on('value', snap => {
    const list = document.getElementById('students-list'); list.innerHTML = "";
    const data = snap.val(); if(!data) return;
    Object.keys(data).forEach(id => {
        list.innerHTML += `<div class="bg-white p-3 rounded-2xl text-center shadow border border-gray-100 relative">${isAdmin?`<button onclick="deleteItem('top_students/${id}')" class="absolute top-1 left-1 bg-red-500 text-white rounded-full w-4 h-4 text-[8px]">Ã—</button>`:''}<img src="${data[id].img||'https://cdn-icons-png.flaticon.com/512/194/194931.png'}" class="w-16 h-16 mx-auto mb-1 rounded-lg"><h4 class="text-[9px] font-bold">${data[id].name}</h4></div>`;
    });
});

db.ref("profile").on("value", snap => {
    if(!snap.exists()) return; const p = snap.val();
    document.getElementById("prof-name-disp").innerText = p.name;
    document.getElementById("prof-wa-link").href = "https://wa.me/" + p.wa;
    document.getElementById("prof-fb-link").href = p.fb;
    if(p.img) document.getElementById("profile-pic-disp").innerHTML = `<img src="${p.img}" class="w-full h-full object-cover">`;
});
// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø¯Ø§Ø¦Ù… (Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ØŒ Ø¢ÙŠÙÙˆÙ†ØŒ PC) ---
let deferredPrompt;
const installBtn = document.getElementById('install-btn');

// 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø´ÙƒÙ„ Ø­ÙŠ
db.ref('app_stats/install_count').on('value', snap => {
    const count = snap.val() || 0;
    const countText = count.toLocaleString();
    if(document.getElementById('install-count-public')) document.getElementById('install-count-public').innerText = countText;
    if(document.getElementById('admin-install-count')) document.getElementById('admin-install-count').innerText = countText;
});

// 2. Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù…Ù‡Ø§ (Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ùˆ PC)
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
});

// 3. Ø¨Ø±Ù…Ø¬Ø© Ø¹Ù…Ù„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
if(installBtn) {
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø£: Ø§Ù„Ø¬Ù‡Ø§Ø² ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØ±ÙŠ (Ù…Ø«Ù„ ÙƒØ±ÙˆÙ… Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                db.ref('app_stats/install_count').transaction(c => (c || 0) + 1);
            }
            deferredPrompt = null;
        } else {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø¨: Ø¢ÙŠÙÙˆÙ†ØŒ Ø£Ùˆ Ù…Ø«Ø¨Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø£Ùˆ Ù…ØªØµÙØ­ Ø¢Ø®Ø±
            // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ ØªÙ‚Ø¯ÙŠØ±Ø§Ù‹ Ù„Ø±ØºØ¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
            db.ref('app_stats/install_count').transaction(c => (c || 0) + 1);
            
            // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ
            alert("Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ:\n\n" + 
                  "â€¢ Ù„Ù„Ø¢ÙŠÙÙˆÙ†: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± (Ù…Ø´Ø§Ø±ÙƒØ©) Ø«Ù… Ø§Ø®ØªØ± (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©).\n" + 
                  "â€¢ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« Ø¨Ø§Ù„Ù…ØªØµÙØ­ Ø«Ù… (ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚).");
        }
    });
}

// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© (Ø¥Ø°Ø§ ÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙØ¹Ù„ "Standalone")
if (window.matchMedia('(display-mode: standalone)').matches) {
    if(document.getElementById('install-container')) document.getElementById('install-container').style.display = 'none';
}
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker Registered'))
            .catch(err => console.log('Service Worker Failed', err));
    });
}
</script>
</body>
</html>